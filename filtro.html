<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario con Filtrado</title>
    <style>
        #filtros {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #resultados {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
        }

        .formulario-enviado {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 3px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <form id="miFormulario">
        <div>
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre" required>
        </div>
        <div>
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" name="fecha" required>
        </div>
        <div>
            <label for="telefono">Teléfono:</label>
            <input type="tel" id="telefono" name="telefono" required>
        </div>
        <button type="submit">Enviar</button>
    </form>

    <div id="filtros">
        <h3>Filtrar Resultados</h3>
        <div>
            <label for="filtroNombre">Nombre:</label>
            <input type="text" id="filtroNombre" onkeyup="filtrarResultados()">
        </div>
        <div>
            <label for="filtroFecha">Fecha:</label>
            <input type="date" id="filtroFecha" onchange="filtrarResultados()">
        </div>
    </div>

    <div id="resultados">
        <h3>Formularios Enviados</h3>
        <div id="listaResultados">
            </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import { getFirestore, collection, addDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBftARJVB3Cq1jQoPXdb-ldF-_NEWnyO_8",
        authDomain: "tcservidor-b8874.firebaseapp.com",
        projectId: "tcservidor-b8874",
        storageBucket: "tcservidor-b8874.firebasestorage.app",
        messagingSenderId: "1033968746876",
        appId: "1:1033968746876:web:d75c3247adc32f785864f9",
        measurementId: "G-R7L2183KKD"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const formulariosCollection = collection(db, "formularios");
      const listaResultadosDiv = document.getElementById('listaResultados');
      const filtroNombreInput = document.getElementById('filtroNombre');
      const filtroFechaInput = document.getElementById('filtroFecha');
      let formulariosData = []; // Almacena todos los datos de los formularios

      // Función para mostrar los formularios en la lista
      function mostrarFormularios(formularios) {
          listaResultadosDiv.innerHTML = '';
          if (formularios.length === 0) {
              listaResultadosDiv.innerHTML = '<p>No se encontraron formularios.</p>';
              return;
          }
          formularios.forEach(formulario => {
              const div = document.createElement('div');
              div.classList.add('formulario-enviado');
              div.innerHTML = `
                  <p><strong>Nombre:</strong> ${formulario.nombre}</p>
                  <p><strong>Fecha:</strong> ${formulario.fecha}</p>
                  <p><strong>Teléfono:</strong> ${formulario.telefono}</p>
              `;
              listaResultadosDiv.appendChild(div);
          });
      }

      // Función para filtrar los resultados
      function filtrarResultados() {
          const filtroNombre = filtroNombreInput.value.toLowerCase();
          const filtroFecha = filtroFechaInput.value;

          const resultadosFiltrados = formulariosData.filter(formulario => {
              const nombreCoincide = formulario.nombre.toLowerCase().includes(filtroNombre);
              const fechaCoincide = !filtroFecha || formulario.fecha === filtroFecha;
              return nombreCoincide && fechaCoincide;
          });

          mostrarFormularios(resultadosFiltrados);
      }

      // Escucha los cambios en la colección de formularios en tiempo real
      onSnapshot(formulariosCollection, (snapshot) => {
          formulariosData = [];
          snapshot.forEach((doc) => {
              formulariosData.push(doc.data());
          });
          filtrarResultados(); // Muestra los resultados iniciales o después de un cambio
      });

      // Código para enviar el formulario
      const formulario = document.getElementById('miFormulario');
      formulario.addEventListener('submit', async (event) => {
          event.preventDefault();

          const nombre = formulario.nombre.value;
          const fecha = formulario.fecha.value;
          const telefono = formulario.telefono.value;

          try {
              await addDoc(formulariosCollection, {
                  nombre: nombre,
                  fecha: fecha,
                  telefono: telefono,
                  timestamp: new Date()
              });
              console.log("Documento escrito con éxito.");
              alert("¡Formulario enviado con éxito!");
              formulario.reset();
          } catch (e) {
              console.error("Error al añadir el documento: ", e);
              alert("Hubo un error al enviar el formulario.");
          }
      });
    </script>
</body>
</html>
